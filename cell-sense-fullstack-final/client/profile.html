<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile | Cell Sense</title>
  <link href="assets/css/material-dashboard.css" rel="stylesheet">
  <link href="assets/css/nucleo-icons.css" rel="stylesheet">
  <link href="assets/css/fontawesome.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.material.css">
</head>
<body class="g-sidenav-show sidenav-pinned bg-gray-100">

  <!-- Sidebar -->
  <aside class="sidenav navbar navbar-vertical bg-gradient-dark fixed-start">
    <div class="sidenav-header text-center">
      <img id="sidebarAvatar" src="default.jpg" class="avatar avatar-sm border-radius-lg shadow-sm mt-3 mb-2">
      <h6 id="sidebarUsername" class="text-white">User</h6>
    </div>
    <hr class="horizontal light mt-0 mb-2">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link text-white active bg-gradient-primary" href="dashboard.html"><i class="material-icons opacity-10">Dashboard</i><span class="nav-link-text ms-2"></span></a></li>
      <li class="nav-item"><a class="nav-link text-white" href="logs.html"><i class="material-icons opacity-10">Log</i><span class="nav-link-text ms-2"></span></a></li>
      <li class="nav-item"><a class="nav-link text-white" href="medication.html"><i class="material-icons opacity-10">Medication</i><span class="nav-link-text ms-2"></span></a></li>
      <li class="nav-item"><a class="nav-link text-white" href="insights.html"><i class="material-icons opacity-10">Insights</i><span class="nav-link-text ms-2"></span></a></li>
      <li class="nav-item"><a class="nav-link text-white" href="profile.html"><i class="material-icons opacity-10">Profile</i><span class="nav-link-text ms-2"></span></a></li>
      <li class="nav-item mt-3"><a class="nav-link text-white" href="login.html"><i class="material-icons opacity-10">Logout</i><span class="nav-link-text ms-2"></span></a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container-fluid py-4">

      <div class="card card-body">
        <h5><i class="material-icons text-dark me-2">settings</i> Profile Settings</h5>

        <form id="profileForm" class="row g-3 mt-3">
          <div class="col-md-6">
            <label class="form-label">Full Name</label>
            <input type="text" id="name" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">New Password</label>
            <input type="password" id="password" class="form-control" placeholder="••••••••" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Profile Picture</label>
            <input type="file" id="profilePicInput" class="form-control" />
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-outline-dark w-100">Save Changes</button>
          </div>
        </form>
      </div>

    </div>
  </main>

  <script>
    const API = 'http://localhost:5000/api';
    const token = localStorage.getItem("token");

    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('sidebarAvatar').src = user.profilePic || 'default.jpg';
    document.getElementById('sidebarUsername').textContent = user.name || 'User';

    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.remove('sidenav-mini', 'g-sidenav-hidden');
      document.body.classList.add('sidenav-pinned', 'g-sidenav-show');
      const sidenav = document.querySelector('.sidenav');
      if (sidenav) {
        sidenav.addEventListener('mouseenter', e => {
          e.stopPropagation();
          document.body.classList.remove('sidenav-mini', 'g-sidenav-hidden');
        });
        sidenav.addEventListener('mouseleave', e => {
          e.stopPropagation();
          document.body.classList.remove('sidenav-mini', 'g-sidenav-hidden');
        });
      }
    });
    

    document.addEventListener("DOMContentLoaded", async () => {
      const res = await fetch(`${API}/users/me`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      document.getElementById("name").value = data.name;
      document.getElementById("email").value = data.email;
    });

    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const picInput = document.getElementById("profilePicInput");

      await fetch(`${API}/users/me`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ name, email, password })
      });

      if (picInput.files.length > 0) {
        const formData = new FormData();
        formData.append("profilePic", picInput.files[0]);

        await fetch(`${API}/users/profile-pic`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });
      }

      alert("Profile updated!");
      document.getElementById("password").value = "";
    });
  </script>
</body>
</html>
